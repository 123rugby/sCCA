---
title: "Select features"
author: "Cedric Huchuan Xia"
date: "10/27/2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE,
  results = FALSE, eval = TRUE, cache = TRUE,
   fig.width = 10, fig.height = 7, tidy = TRUE
)
knitr::opts_knit$set(root.dir = '~/Google Drive/TDSlab/sCCA/aim1/')
```
  
```{r load data}
setwd('~/Google Drive/TDSlab/sCCA/aim1/')
load("~/Google Drive/TDSlab/sCCA/aim1/data/go1_train_power_ft.RData")
```


```{r calculate covariance}
power_mad<- apply(power,2,function(x) round(mad(x),digits=4))
plot(power_mad[order(-power_mad)],main='Connectivity Variance Analysis',xlab='Connectivity Feature',ylab='Median Abs. Deviation')
  salient_percent <- c(quantile(power_mad,c(.9,.95)))
  abline(h=salient_percent, col='red')
  ft_cutoff <- mean(which(power_mad[order(-power_mad)]== quantile(power_mad,.95)))
  abline(v=ft_cutoff, col='blue')
  text(x=ft_cutoff-1200,y=0.10,labels = paste(ft_cutoff))
  text(x=c(5000,4000),y=salient_percent+0.005,labels = paste(c('90','95'),' %',sep='') )
  
# ggplot2 version
power_mad_order <- data.frame(numedge = as.factor(1:dim(power)[2],mad = power_mad[order(-power_mad)]))
salient_percent <- c(quantile(power_mad,c(.95,.9,.75,.5)))
thresh <- c(1,sapply(seq_along(salient_percent),function(i) round(mean(which(power_mad_order$mad == salient_percent[i])))), dim(power)[2])
power_mad_order$group <- as.factor(c(rep(1,thresh[2]),rep(2,thresh[3]-thresh[2]),rep(3,thresh[4]-thresh[3]),rep(4,thresh[5]-thresh[4]),rep(5,thresh[6]-thresh[5])))
p <- ggplot(power_mad_order,aes(numedge,mad)) +
     geom_bar(stat = 'identity',aes(fill= group,color=group)) +
     scale_fill_brewer() +
     scale_x_discrete(breaks=c(thresh,dim(power)[2]),name = "Individual Edge") +
     scale_y_continuous(name = "Median Abs. Deviation") +
     theme_classic(base_size = 20) +
     annotate("text", x = thresh[1]+(thresh[2]-thresh[1])/2, y = 0.33,label = "95%",size =4.5,colour = "black" ) +
     annotate("text", x = thresh[2]+(thresh[3]-thresh[2])/2, y = 0.3,label = "90%",size =4.5,colour = "black" ) +
     annotate("text", x = thresh[3]+(thresh[4]-thresh[3])/2, y = 0.28,label = "75%",size =4.5,colour = "black" ) +
    annotate("text", x = thresh[4]+(thresh[5]-thresh[4])/2, y = 0.26,label = "50%",size =4.5,colour = "black" ) +
     theme(legend.position="none") +
    theme(axis.text.x=element_text(angle=90,hjust = 1,vjust = +0.5))
p

```

```{r compile connectivity features and regress}
inc_idx <- which(power_mad>=salient_percent[1])
inc_net <- power[,inc_idx]
covariates <- read.csv("./data/go1_train_subj_order.csv")
covariates$sex <- as.factor(covariates$sex)
covariates$race2 <- as.factor(covariates$race2)
power.rgr <- matrix(NA, nrow = dim(inc_net)[1], ncol = dim(inc_net)[2])
rownames(power.rgr) <- rownames(power)
power.rgr <- apply(inc_net, 2, function(x) residuals.glm(glm(x ~ ageAtGo1Scan + 
    sex + race2 + relMeanRMSmotion, data = covariates ), type = "response"))
net_skew <- apply(power.rgr,2,skewness)
plot(net_skew,main='Sknewness Analysis of Connectivity Features',xlab='Connectivity Feature',ylab='Skewness')

# regress out covariates on the individual edges
power.rgr <- matrix(NA, nrow = dim(power)[1], ncol = dim(power)[2])
power.rgr <- apply(power, 2, function(x) residuals.glm(glm(x ~ ageAtGo1Scan + 
    sex + race2 + relMeanRMSmotion, data = covariates ), type = "response"))

# PCA-on these data
power.rgr.pca <-prcomp(power.rgr, center = FALSE)
save(power.rgr.pca,file='./result/power_regr_pca1612.RData')

```

```{r regress clinical features and regress}
#med <- read.csv("./data/go1_train_112_clinical_data.csv")
med <- read.csv("./data/n1601_goassess_112_itemwise_vars_20161214.csv")

med.torgr <- within(med, rm("bblid"))
rownames(med.torgr) <- med$bblid
#plot(skewness(med.torgr),main='Sknewness Analysis of Raw Clinical Features',xlab='Psychiatric Symptoms',ylab='Skewness')
#regress out the continous variables (SIPs)

med.rgr.cont <- apply(med.torgr[,1:12], 2, function(x) residuals.glm(glm(x ~ ageAtGo1Scan + 
    sex + race2, data = covariates ), type = "response"))
#regress out the binary variables (everything else)
med.rgr.binary <- apply(med.torgr[,13:112], 2, function(x) residuals.glm(glm(x ~ ageAtGo1Scan + 
    sex + race2, family= binomial(link="logit"),data = covariates ), type = "response"))

med.rgr <- cbind(med.rgr.cont,med.rgr.binary)
rownames(med.rgr) <- med$bblid
colnames(med.rgr) <- colnames(med.torgr)

plot(skewness(med.rgr),main='Skewness Analysis of Regressed Clinical Features',xlab='Psychiatric Symptoms',ylab='Skewness')

```

```{r visulize which features}
power.cln.aj <- array(NA, c(264,264,682))
for (i in 1:682) {
  tempmax <- power.cln.aj[ , ,i]
  tempmax[upper.tri(tempmax,diag=F)] <- as.numeric(power.clearn[i,])
  tempmax <- sna::symmetrize(tempmax,rule='upper')
  power.cln.aj[ , , i] <- tempmax
  print(paste('No.',i,'subject'))
}

power.cln.ave <- apply(power.cln.aj, c(1,2), function(x) mean(na.omit(x)))
image(power.cln.ave)
```


```{r change 3K back to 264 by 264 matrix}
power.rgr.mean <- colMeans(power.rgr)
power.norgr.mean<- colMeans(inc_net)
full.mat <- array(NA,c(264,264)) #create a blank matrix
#fill in which edge was selected
full.mat[upper.tri(full.mat,diag=F)] <- as.numeric(power_mad>=salient_percent[1])
#multiple weight and edge strength
edge.strength = colMeans(power.rgr,na.rm = T)
edge.str.abs = abs(edge.strength)
edge.n.weight = sign(edge.strength) * p3Km112.u.mean[,3]
full.mat[which(full.mat > 0) ]<- edge.n.weight
full.mat[which(full.mat > 0) ]<- -p3Km112.u.mean[,1]
full.mat[which(full.mat > 0) ]<- power.norgr.mean

full.mat <- sna::symmetrize(full.mat,rule = 'upper')
diag(full.mat) <-0
netdim.mat <- full.mat
DMN <- netdim.mat[modix,modix]
levelplot(DMN, par.settings = BuRdTheme(), at = seq(-max(abs(DMN)),max(abs(DMN)),length.out = 10 ), scales=list( x=list(draw=FALSE), y=list(draw=FALSE)), xlab='',ylab='',main='DMN')
levelplot(full.mat,par.settings = BuRdTheme(), at = seq(-0.023,0.023,length.out = 100))
```
