{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Bootstrap sCCA results\"\noutput: html_notebook\n---\n\n```{r setup}\nknitr::opts_knit$set(root.dir = '/Users/hxia/Desktop/BBL/')\nrequire(\"rasterVis\")\nrequire('PMA')\nrequire('Matrix')\nrequire('parallel')\nrequire('emdbook')\nrequire('caret')\nrequire('R.matlab')\nrequire('MASS')\nrequire('permute')\nrequire('matrixStats')\nrequire('scales')\nrequire('ggrepel')\nrequire('cowplot')\nsource('~/Desktop/BBL/projects/xiaNetworkCca/sCCA/code/cca_functions.R')\n```\n\n```{r load sCCA results}\nload(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_cca.RData\")\n```\n\n\n```{r bootstrap}\n## bootstrap\n\nbootid<-createResample(subjid$overall_psychopathology_4factor, list = T, times = bootnum)\nbrain_boot <- mclapply(bootid, function(id) data$brain[id,],mc.cores = 5)\nbehavior_boot <- mclapply(bootid, function(id) data$behavior[id,],mc.cores = 5)\n\np3Km111.org<-ccaDW(data$brain,data$behavior,0.8,0.4,dim(data$behavior)[2])\n\nsave(p3Km111.org, file = \"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_p3Km111_org.RData\")\np3Km111.boot<- mclapply(seq_along(bootid),function(i) ccaDW(brain_boot[[i]],behavior_boot[[i]],0.8,0.4,10),mc.cores = 5)\n\nload(\"~/Desktop/BBL/projects/xiaNetworkCca/sCCA/aim1/result/201701/p3Km111_boot501.RData\")\np3Km111.boot1 <- p3Km111.boot\nload(\"~/Desktop/BBL/projects/xiaNetworkCca/sCCA/aim1/result/201701/p3Km111_boot502.RData\")\np3Km111.boot2 <- p3Km111.boot\np3Km111.boot <- append(p3Km111.boot1,p3Km111.boot2)\nsave(p3Km111.boot, file = \"~/Desktop/BBL/projects/xiaNetworkCca/sCCA/aim1/result/201701/p3Km111_boot1000.RData\")\n```\n\n```{r load processed data}\nload(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_p3Km111_org.RData\")\nload(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/p3Km111_boot1000.RData\")\n```\n\n```{r compute confidence interval}\nbootnum = 1000\np3Km111.boot.ro<- lapply(1:bootnum,function(i) reorderCCA(p3Km111.boot[[i]],p3Km111.org,10) )\n\np3Km111.boot.u <- list(u1 =  sapply(1:bootnum, function(i) p3Km111.boot.ro[[i]]$u[,1]),\n                       u2 =  sapply(1:bootnum, function(i) p3Km111.boot.ro[[i]]$u[,2]),\n                       u3 =  sapply(1:bootnum, function(i) p3Km111.boot.ro[[i]]$u[,3]))\np3Km111.boot.v <- list(v1 =  sapply(1:bootnum, function(i) p3Km111.boot.ro[[i]]$v[,1]),\n                       v2 =  sapply(1:bootnum, function(i) p3Km111.boot.ro[[i]]$v[,2]),\n                       v3 =  sapply(1:bootnum, function(i) p3Km111.boot.ro[[i]]$v[,3]))\np3Km111.boot.cor <-  sapply(1:1000, function(i) p3Km111.boot.ro[[i]]$cor)\n\nsave(list= ls(pattern = \"p3Km111.boot*\"), file = \"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_boot.RData\")\nload(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_boot.RData\")\n\nu1.plot <- bootplot_u(p3Km111.org$u[,1],p3Km111.boot.u$u1)\nu2.plot <- bootplot_u(p3Km111.org$u[,2],p3Km111.boot.u$u2)\nu3.plot <- bootplot_u(p3Km111.org$u[,3],p3Km111.boot.u$u3)\n\nv1.plot <- bootplot(p3Km111.org$v[,1],p3Km111.boot.v$v1)\nv2.plot <- bootplot(p3Km111.org$v[,2],p3Km111.boot.v$v2)\nv3.plot <- bootplot(p3Km111.org$v[,3],p3Km111.boot.v$v3)\n\nls(pattern=\"*.plot\")\nsave(list = ls(pattern=\"*.plot\"), file =\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_final_loadings.RData\")\n```\n\n```{r organize item questions }\n#load('./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_med_rgr_data.RData')\n#item<-read.csv('./studies/pnc/n1601_dataFreezeDec2016/clinical/annotation112item_hxia.csv')\n#load(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_final_loadings.RData\")\n#colnames(pwr_train_med_rgr) <- toupper(colnames(pwr_train_med_rgr))\n#item <- item[match(colnames(pwr_train_med_rgr),item$clinicalcode),]\n#save(item, file = \"./projects/xiaNetworkCca/sCCA/aim1/data/med_item_annotation.RData\")\nload(\"./projects/xiaNetworkCca/sCCA/aim1/data/med_item_annotation.RData\")\nSTAI.label<- read.csv(\"./studies/pnc/n1601_dataFreezeDec2016/cnb/STAI_pre_traits_xia.csv\")\ncolnames(STAI.label) <- colnames(item)\nitem_n_trait <- rbind(item,STAI.label)\nsave(item_n_trait, file = \"./projects/xiaNetworkCca/sCCA/aim1/data/med_trait_item_annotation.RData\")\n\n```\n\n```{r visualize clinical items}\nmed_vis(v1.plot,\"Dimension 1\")\nmed_vis(v2.plot,\"Dimension 2\")\nmed_vis(v3.plot,\"Dimension 3\")\n```\n\n```{r visualize brain dimension, fig.height=8, fig.width=8}\nload(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_parcels.RData\")\nload(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_3k_stats.RData\")\nload(\"./projects/xiaNetworkCca/sCCA/aim1/result/201701/pwr_train_net_ft.RData\")\n```\n\n```{r }\nbrain1 <- brain_vis(u1.plot,\"Dimension 1\",-1,pwr.3k.train.idx,parcelsTR)\nbrain2 <- brain_vis(u2.plot,\"Dimension 2\",-1,pwr.3k.train.idx,parcelsTR)\nbrain3 <- brain_vis(u3.plot,\"Dimension 3\",+1,pwr.3k.train.idx,parcelsTR)\n```\n\n```{r}\nmask_mat <- all_train_mask$ave_mat\n\nbr.by.ft1 <- load_by_ft_plot(brain1$mat,mask_mat)\nbr.by.ft2 <- load_by_ft_plot(brain2$mat,mask_mat)\nbr.by.ft3 <- load_by_ft_plot(brain3$mat,mask_mat)\n\nmatmod <- mod_rich_within(mask_mat)\nnetmod1<-mod_rich_within(br.by.ft1$mat)\nnetmod2<-mod_rich_within(br.by.ft2$mat)\nnetmod3<-mod_rich_within(br.by.ft3$mat)\n\nmatmod_sig_idx <- which(p.adjust(matmod$PVAL,method = \"fdr\") < 0.05)\nmatmod_sig <- unique(parcelsTR$System)[matmod_sig_idx]\n\nnetmod1_sig <- matmod_sig[which(p.adjust(netmod1$PVAL[matmod_sig_idx],method = \"fdr\")< 0.05 )]\nnetmod1_sig_idx <- unique(parcelsTR$Community[which(parcelsTR$System == netmod1_sig)]) +1\n\nnetmod2_sig <- matmod_sig[which(p.adjust(netmod2$PVAL[matmod_sig_idx],method = \"fdr\")< 0.05 )]\nnetmod2_sig_idx <- unique(parcelsTR$Community[which(parcelsTR$System == netmod2_sig)]) +1\n\nnetmod3_sig <- matmod_sig[which(p.adjust(netmod3$PVAL[matmod_sig_idx],method = \"fdr\")< 0.05 )]\nnetmod3_sig_idx <- unique(parcelsTR$Community[which(parcelsTR$System == netmod3_sig)]) +1\n\n#mod_size <- sapply(c(-1,1:13),function(x) length(which(parcelsTR$Community == x)))\n#mod_size[order(-mod_size)]\n#unique(parcelsTR$System)[order(-mod_size)]\n\n# plot module after MAD\nmad_mod_plot <- lapply(as.list(matmod_sig_idx),function(x) within_mod_plot(mad_mat,x))\nmad_mod_calc <- sapply(as.list(matmod_sig_idx),function(x) within_mod_calc(mad_mat,x))\n\n\n# plot module for Dim 1\ndim1_mod_plot <- lapply(as.list(netmod1_sig_idx),function(x) within_mod_plot(br.by.ft1$mat,x))\ndim1_mod_calc <- sapply(as.list(netmod1_sig_idx),function(x) within_mod_calc(br.by.ft1$mat,x))\n\n# plot module for Dim 2\ndim2_mod_plot <- lapply(as.list(netmod2_sig_idx),function(x) within_mod_plot(br.by.ft2$mat,x))\ndim2_mod_calc <- sapply(as.list(netmod2_sig_idx),function(x) within_mod_calc(br.by.ft2$mat,x))\n\n# plot module for Dim 3\ndim3_mod_plot <- lapply(as.list(netmod3_sig_idx),function(x) within_mod_plot(br.by.ft3$mat,x))\ndim3_mod_calc <- sapply(as.list(netmod3_sig_idx),function(x) within_mod_calc(br.by.ft3$mat,x))\n\n#save the above plots\nlistplot(mad_mod_plot,\"enrich_mad\")\nlistplot(dim1_mod_plot,\"enrich_dim1\")\nlistplot(dim2_mod_plot,\"enrich_dim2\")\nlistplot(dim3_mod_plot,\"enrich_dim3\")\n\n```\n\n```{r between mod}\nbetween_name <- mod_calc_between_name(unique(parcelsTR$System))\nmatmod_bt <- mod_rich_between(mask_mat)\n\nnetmod1_bt<-mod_rich_between(br.by.ft1$mat)\nnetmod1_bt$MOD <- matmod_bt$MOD[which(p.adjust(netmod1_bt$PVAL[matmod_bt$MODid], method = 'fdr') < 0.05)]\nnetmod1_bt$MODid <- matmod_bt$MODid[which(p.adjust(netmod1_bt$PVAL[matmod_bt$MODid], method = 'fdr') < 0.05)]\n\nnetmod2_bt<-mod_rich_between(br.by.ft2$mat)\nnetmod2_bt$MOD <- matmod_bt$MOD[which(p.adjust(netmod2_bt$PVAL[matmod_bt$MODid], method = 'fdr') < 0.05)]\nnetmod2_bt$MODid <- matmod_bt$MODid[which(p.adjust(netmod2_bt$PVAL[matmod_bt$MODid], method = 'fdr') < 0.05)]\n\nnetmod3_bt<-mod_rich_between(br.by.ft3$mat)\nnetmod3_bt$MOD <- matmod_bt$MOD[which(p.adjust(netmod3_bt$PVAL[matmod_bt$MODid], method = 'fdr') < 0.05)]\nnetmod3_bt$MODid <- matmod_bt$MODid[which(p.adjust(netmod3_bt$PVAL[matmod_bt$MODid], method = 'fdr') < 0.05)]\n\nmad_bt_mod_plot <- between_mod_plot(matmod_bt,mad_mod_calc,\"MAD Mask\")\ndim1_bt_mod_plot <- between_mod_plot(netmod1_bt,dim1_mod_calc,\"Dimension 1\")\ndim2_bt_mod_plot <- between_mod_plot(netmod2_bt,dim2_mod_calc,\"Dimension 2\")\ndim3_bt_mod_plot <- between_mod_plot(netmod3_bt,dim3_mod_calc,\"Dimension 3\")\n\nmad_bt_mod_edge_plot <- between_mod_load_plot(matmod_bt,mad_mod_calc,\"MAD Mask\")\ndim1_bt_mod_load_plot <- between_mod_load_plot(netmod1_bt,dim1_mod_calc,\"Dimension 1\")\ndim2_bt_mod_load_plot <- between_mod_load_plot(netmod2_bt,dim2_mod_calc,\"Dimension 2\")\ndim3_bt_mod_load_plot <- between_mod_load_plot(netmod3_bt,dim3_mod_calc,\"Dimension 3\")\n\nbt_mod_diff(dim1_bt_mod_load_plot,dim2_bt_mod_load_plot,\"Dim1 - Dim2\")\nbt_mod_diff(dim2_bt_mod_load_plot,dim3_bt_mod_load_plot,\"Dim2 - Dim3\")\nbt_mod_diff(dim1_bt_mod_load_plot,dim3_bt_mod_load_plot,\"Dim1 - Dim3\")\n\nmad_bt_mod_edge_plot$plot\ndim1_bt_mod_load_plot$plot\ndim2_bt_mod_load_plot$plot\ndim3_bt_mod_load_plot$plot\n\n\n\n```\n\n\n\n\n\n",
    "created" : 1486487472309.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1468096521",
    "id" : "ADD03DD",
    "lastKnownWriteTime" : 1486704342,
    "last_content_update" : 1486705087256,
    "path" : "~/Desktop/BBL/projects/xiaNetworkCca/sCCA/code/pwr_bootstrap.Rmd",
    "project_path" : "pwr_bootstrap.Rmd",
    "properties" : {
        "chunk_output_type" : "inline",
        "last_setup_crc32" : "A65079FE56c9b013"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}